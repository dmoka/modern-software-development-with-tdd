<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="./assets/style.css">
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Test doubles

---

# Test doubles


Term ‚Äúdouble‚Äù comes from movies

Goals:
- Replacing production grade dependencies

- Achieving fast and robust tests

- Isolating business logic

Utilizing Dependency Injection (DI)

---
# The 5 Test doubles

Dummy

Stub

Spy

Mock

Fake

<div class="green-bg" style="text-align: center;">
  They differ in intent
</div>


---
# Dummy

No behaviours

For initialization

Dummy values or objects

<div style="text-align: center;">
  <img src="./assets/dummy.png" alt="Example Image">
</div>


---

# Dummy

```
public class UserService
{
    private readonly ILogger _logger;

    public UserService(ILogger logger)
    {
        _logger = logger;
    }

    public bool ValidateUser(User user)
    {
        return UserValidator.Validate(user);
    }

    //Other service methods that use the logger
    ...
}

```

---

# Dummy

```
public class DummyLogger : ILogger
{
    public void Log() {}
}
```

```
[Test]
public void UserShouldBeValid_whenAllFieldsFilled() 
{
    //Arrange
    var user = new User("Arnold", 42, "San Francisco");

    var dummyLogger = new DummyLogger();
    var userService = new UserService(dummyLogger);

    //Act
    var isUserValid = userService.ValidateUser(user);

    //Assert
    Check.That(isUserValid).IsEqualTo(true);
}

```


---
# Stub

Simulating incoming interactions

Hard-coded value

Irrelevant behaviour

<div style="text-align: center;">
  <img src="./assets/stub.png" alt="Example Image">
</div>
---

# Stub

```
public class UserService
{
    private IWageCalculator _wageCalculator;

    public UserService(IWageCalculator wageCalculator)
    {
        _wageCalculator = wageCalculator;
    }

    public Payslip GeneratePayslip(User user)
    {
        var userWage = _wageCalculator.Calculate(user);

        return new PaySlip(userWage);
    }
}
```

---

# Stub

```
public class WageCalculatorStub : IWageCalculator
{
    public decimal Calculate(User user)
    {
        return 3700;
    }
}
```
```
[Test]
public void GeneratedPasySlipShouldHaveWageSet()
{
    //Arrange
    var user = new User("Arnold", 42, "San Francisco");

    var userService = new UserService(new WageCalculatorStub());

    //Act
    var paySlip = userService.GenerlatePayslip(user);

    //Assert
    Check.That(paySlip.GetWage()).IsEqualTo(3700);
}
```
---
# Spy

Gather info about dependencies

Record and verify outgoing interactions

Access internals

<div style="text-align: center;">
  <img src="./assets/spy.png" alt="Example Image">
</div>

---

# Spy

```
public bool ValidateUser(User user)
{
    var isUserValid = UserValidator.Validate(user);
    if (!isUserValid) 
    {
        _logger.Log($"The user is invalid");
    };

    return isUserValid;
}
```

---

# Spy

```
public class LoggerSpy : ILogger
{
    private IList<string> LogMessages = new List<string>();

    public void Log(string message) 
    {
        LogMessages.Add(message);        
    }

    public int TimesCalled() 
    {
        return LogMessages.Count;
    }

    public bool ContainsMessage(string text)
    {
        return LogMessages.Any(msg => msg.Contains(text));
    }

}
```

---

# Spy

```
[Test]
public void UserShouldBeValid_whenAllFieldsFilled() 
{
    //Arrange
    var user = new User("Arnold", 42, "");

    var loggerSpy = new LoggerSpy();
    var userService = new UserService(loggerSpy);

    //Act
    var isUserValid = userService.ValidateUser(user);

    //Assert
    Check.That(loggerSpy.TimesCalled()).IsEqualTo(1);
    Check.That(loggerSpy
       .ContainsMessage("is invalid")).IsTrue();
}

```

---

# Mock

Most versatile test double
- Enforce behaviours
- Verify outoing interactions
- Eeasy to create by 3rd party libs (Moq in .NET)


<div style="text-align: center;">
  <img src="./assets/mock.png" alt="Example Image"  style="width:400px;">
</div>

---
# Mock

```
public class UserService
{
    private readonly IUserRepository _userReposistory;

    public UserService(IUserRepository userRepository)
    {
        _userReposistory = userRepository;
    }

    public void CreateUser(User user) 
    {
        UserValidator.Validate(user);

        _userReposistory.Create(user);
    }
}
```
---

# Mock

```
[Test]
public void UserShouldBeCreated_whenUserIsValid() 
{
    //Arrange
    var user = new User("Arnold", 42, "San Francisco");

    var repositoryMock = new Mock<IUserRepository>();

    var userService = new UserService(repositoryMock.Object);

    //Act
    userService.CreateUser(user);

    //Assert
    repositoryMock
        .Verify(mock => mock.Create(user), Times.Once);
}
```

---

# Fake

Lightweight implementation

Simulating business behaviours

State verification

<div style="text-align: center;">
  <img src="./assets/fake.png" alt="Example Image"  style="width:400px;">
</div>

---
# Fake

```
public class UserService
{
    private readonly IUserRepository _userReposistory;

    public UserService(IUserRepository userRepository)
    {
        _userReposistory = userRepository;
    }

    public void CreateUser(User user) 
    {
        UserValidator.Validate(user);

        _userReposistory.Create(user);
    }
}
```


---
# Fake

```
public class UserRepositoryFake : IUserRepository
{
    public List<User> Users = new List<User>();

    public void Create(User user)
    {
        Users.Add(user);
    }
}
```
---

# Fake

```
[Test]
public void UserShouldBeCreated_whenUserIsValid()
{
    //Arrange
    var user = new User("Arnold", 42, "San Francisco");
    var repositoryFake = new UserRepositoryFake();

    var userService = new UserService(repositoryFake);

    //Act
    userService.CreateUser(user);

    //Assert
    Check.That(repositoryFake.Users.Contains(user)).IsTrue();
}
```

---
class: center, middle

# So which one to use?
---

# Cheatsheet


Dummy: initialization

Stub: simulating incoming interactions

Spy: record and verify outgoing interactions

Mock: enforce behaviors and verify outgoing interactions

Fake: lightweight implementation of the dependency

---
class: center, middle

# Two common smells

---
# Smell #1 - Fragile tests

‚ùå Problem

Your tests fail to compile when you change the production code.

üîÉ Cause

Your tests are coupled to low-level implementation details such as internal functions or classes.

---
# Smell #1 - Fragile tests

Coupled to implementation details like `FindById(..)` and `Store(..)` methods.

```cs
[Test]
public void UserServiceShouldActivateUser()
{
    // Arrange
    var user = new User();

    var userStoreMock = new Mock<IUserStore>();
*    userStoreMock.Setup(mock => mock.FindById(It.IsAny<Guid>())).Returns(user);

    var userService = new UserService(userStoreMock.Object);

    // Act
    userService.Activate(user);

    // Assert
*    userStoreMock.Verify(x => x.Store(It.Is<User>(u => u.IsActive)), Times.Once);
}
```

---
# Smell #1 - Fragile tests

‚úÖ Solution: couple tests to the behaviors of the public APIs

```cs
[Test]
public void UserServiceShouldActivateUser()
{
    // Arrange
    var user = new User();
    var userStoreFake = new UserStoreFake(user);

    var userService = new UserService(userStoreFake);

    // Act
    userService.Activate(user);

    // Assert
    user = userStoreFake.Users.First();
    Check.That(user.IsActive).IsTrue();
}
```
---


# Smell #2 - Mocking 3rd party libraries

‚ùå Symptom

Mocking 3rd-party libraries directly

üîÉ Cause

Mocking libraries are easy to misuse.
```
List<UserProfile> GetUserProfiles()
  {
      _azureAPI.Authorize();  // Leads to complex test setup
      let azureUsers = _azureAPI.GetUsers();  // Tight coupling
  
      let profiles = ConvertToUserProfiles(azureUsers);

      return FormatProfiles(profiles);
  }
  ```

---
# Smell #2 -  Mocking 3rd party libraries

‚úÖ Solution: Mock your dependencies using one of the five test doubles.

```
interface IUsersService
{
    IList<User> GetUsers();  // Expose only what you need
}

List<UserProfile> GetUserProfiles()
{
    let users = _usersService.GetUsers();  // Easily mockable

    let profiles = ConvertToUserProfiles(users);
    return FormatProfiles(profiles);
}

```

---
class: center, middle

# The two schools of TDD
---



    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({  
        highlightLanguage: 'cs',
         highlightStyle: 'monokai', highlightLines: true});    
    </script>
  </body>
</html>
